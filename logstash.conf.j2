input {
  http {
    host => "0.0.0.0"
    port => 5044
    
    # Desligar ECS para evitar conflitos de campos automáticos
    ecs_compatibility => "disabled"

    # Credenciais definidas no teu script Python
    user => "botas"
    password => "minha_senha_123"

    # Coloca o JSON recebido dentro do campo [python_event] para organizarmos depois
    codec => json {
      target => "python_event"
    }
  }
}

filter {
  # 1) Mover e renomear os dados que vêm do Python
  mutate {
    rename => { "[python_event][source]" => "[sensor][source]" }
    rename => { "[python_event][device]" => "[sensor][device]" }
    rename => { "[python_event][topic]"  => "[sensor][topic]" }
    rename => { "[python_event][ingested_at]" => "ingested_at" }
    
    # O 'payload' (onde estão os valores do Zigbee) vai para um campo temporário
    rename => { "[python_event][payload]" => "payload_data" }
  }

  # 2) Processar TEMPERATURA (só se existir na mensagem)
  if [payload_data][temperature] {
    mutate {
      add_field => { "temperature" => "%{[payload_data][temperature]}" }
    }
    mutate {
      convert => { "temperature" => "float" }
    }
  }

  # 3) Processar HUMIDADE (só se existir na mensagem)
  if [payload_data][humidity] {
    mutate {
      add_field => { "humidity" => "%{[payload_data][humidity]}" }
    }
    mutate {
      convert => { "humidity" => "float" }
    }
  }

  # 4) Processar QUALIDADE DO SINAL (útil para Zigbee)
  if [payload_data][linkquality] {
    mutate {
      add_field => { "link_quality" => "%{[payload_data][linkquality]}" }
    }
    mutate {
      convert => { "link_quality" => "integer" }
    }
  }
  
  # 5) Processar BATERIA (útil para sensores a pilhas)
  if [payload_data][battery] {
    mutate {
      add_field => { "battery" => "%{[payload_data][battery]}" }
    }
    mutate {
      convert => { "battery" => "integer" }
    }
  }

  # 6) Limpeza final (Remove campos técnicos que não interessam no Kibana)
  mutate {
    remove_field => [
      "python_event", 
      "headers", 
      "event", 
      "host", 
      "@version",
      "url",
      "user_agent",
      "http",
      "payload_data" # Removemos o bruto depois de extrair o que queríamos
    ]
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "salalimpa-%{+YYYY.MM}"
    user => "elastic"
    password => "changeme"
  }

  # Mantemos o stdout para veres no terminal se está a funcionar
  stdout {
    codec => rubydebug
  }
}
